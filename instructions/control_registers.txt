> ../Ë£ÇÁ∫π#978:
### –†–µ–≥–∏—Å—Ç—Ä—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è x86/x86-64: –ø–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ

–†–µ–≥–∏—Å—Ç—Ä—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (Control Registers, CR0-CR4, CR8) ‚Äî —ç—Ç–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä—ã –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞, —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏: –∑–∞—â–∏—â—ë–Ω–Ω—ã–º —Ä–µ–∂–∏–º–æ–º, —Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–π –∞–¥—Ä–µ—Å–∞—Ü–∏–µ–π, –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é. –û–Ω–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –≤ –∫–æ–¥–µ —è–¥—Ä–∞ (Ring 0).

---

## üîπ 1. CR0 (Control Register 0)
–û—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞–º–∏ —Ä–∞–±–æ—Ç—ã –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞.

| –ë–∏—Ç  | –ù–∞–∑–≤–∞–Ω–∏–µ       | –û–ø–∏—Å–∞–Ω–∏–µ                                                                 |
|------|----------------|-------------------------------------------------------------------------|
| 0    | PE         | –ó–∞—â–∏—â—ë–Ω–Ω—ã–π —Ä–µ–∂–∏–º (Protected Mode). 1 = –≤–∫–ª—é—á—ë–Ω                          |
| 1    | MP         | Monitor Coprocessor. –£–ø—Ä–∞–≤–ª—è–µ—Ç WAIT/FWAIT –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏                  |
| 2    | EM         | –≠–º—É–ª—è—Ü–∏—è —Å–æ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ (–µ—Å–ª–∏ 1, x87/MMX –≤—ã–∑—ã–≤–∞—é—Ç #UD)                    |
| 3    | TS         | Task Switched. –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –∑–∞–¥–∞—á                      |
| 4    | ET         | Extension Type (—É—Å—Ç–∞—Ä–µ–ª, –¥–ª—è 387 FPU)                                   |
| 5    | NE         | Numeric Error. 1 = x87 –æ—à–∏–±–∫–∏ —á–µ—Ä–µ–∑ #MF, 0 = —á–µ—Ä–µ–∑ IRQ13                |
| 16   | WP         | Write Protect. 1 = –∑–∞–ø—Ä–µ—â–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ R/O —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–∞–∂–µ –¥–ª—è Ring 0      |
| 18   | AM         | Alignment Mask. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è (–µ—Å–ª–∏ AC=1 –≤ EFLAGS)              |
| 29   | NW         | Not Write-through. –û—Ç–∫–ª—é—á–∞–µ—Ç write-through –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ                  |
| 30   | CD         | Cache Disable. 1 = –∫—ç—à –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ –æ—Ç–∫–ª—é—á—ë–Ω                              |
| 31   | PG         | –°—Ç—Ä–∞–Ω–∏—á–Ω–∞—è –∞–¥—Ä–µ—Å–∞—Ü–∏—è (Paging). 1 = –≤–∫–ª—é—á–µ–Ω–∞                             |

–ü—Ä–∏–º–µ—Ä –≤–∫–ª—é—á–µ–Ω–∏—è –∑–∞—â–∏—â—ë–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –∏ —Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–π –∞–¥—Ä–µ—Å–∞—Ü–∏–∏:
mov eax, cr0
or eax, 0x80000001  ; –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PG (–±–∏—Ç 31) –∏ PE (–±–∏—Ç 0)
mov cr0, eax
---

## üîπ 2. CR1
–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω ‚Äî –≤ —Ç–µ–∫—É—â–∏—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞—Ö –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.

---

## üîπ 3. CR2 (Control Register 2)
–•—Ä–∞–Ω–∏—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å, –≤—ã–∑–≤–∞–≤—à–∏–π Page Fault (#PF).  
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è Page Fault.
- –í 64-–±–∏—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ ‚Äî CR2 —Ä–∞—Å—à–∏—Ä–µ–Ω –¥–æ 64 –±–∏—Ç (–≤ AMD ‚Äî CR2H –¥–ª—è —Å—Ç–∞—Ä—à–∏—Ö –±–∏—Ç).

–ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ Page Fault:
page_fault_handler:
    mov rax, cr2      ; –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å, –≤—ã–∑–≤–∞–≤—à–∏–π –æ—à–∏–±–∫—É
    call handle_pf    ; –í–∞—à –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    iret
---

## üîπ 4. CR3 (Control Register 3)
–£–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —Ç–∞–±–ª–∏—Ü—É —Å—Ç—Ä–∞–Ω–∏—Ü (PML4/PDPT).  
| –ë–∏—Ç  | –û–ø–∏—Å–∞–Ω–∏–µ                                                                 |
|------|-------------------------------------------------------------------------|
| 0-11 | –§–ª–∞–≥–∏ (PWT, PCD, –∏ –¥—Ä.)                                                 |
| 12-63| –§–∏–∑–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å –∫–æ—Ä–Ω–µ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä–∞–Ω–∏—Ü (PML4 –¥–ª—è x86-64)              |

–§–ª–∞–≥–∏:
- PCD (Page Cache Disable): 1 = –∑–∞–ø—Ä–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü —Å—Ç—Ä–∞–Ω–∏—Ü.
- PWT (Page Write-Through): 1 = —Å–∫–≤–æ–∑–Ω–∞—è –∑–∞–ø–∏—Å—å (write-through) –≤ –∫—ç—à.

–ü—Ä–∏–º–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ CR3:
mov eax, [page_directory_ptr]
and eax, 0xFFFFF000  ; –û—á–∏—â–∞–µ–º —Ñ–ª–∞–≥–∏
or eax, 0x00000001   ; PCD=0, PWT=0
mov cr3, eax         ; –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–¥—Ä–µ—Å —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä–∞–Ω–∏—Ü
---

## üîπ 5. CR4 (Control Register 4)
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞.

| –ë–∏—Ç  | –ù–∞–∑–≤–∞–Ω–∏–µ       | –û–ø–∏—Å–∞–Ω–∏–µ                                                                 |
|------|----------------|-------------------------------------------------------------------------|
| 0    | VME        | Virtual-8086 Mode Extensions                                            |
| 1    | PVI        | Protected-Mode Virtual Interrupts                                       |
| 2    | TSD        | Time Stamp Disable (RDTSC —Ç–æ–ª—å–∫–æ –≤ Ring 0)                              |
| 3    | DE         | Debugging Extensions                                                    |

> ../Ë£ÇÁ∫π#978:
| 4    | PSE        | Page Size Extensions (1 = 4 –ú–ë —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ 32-–±–∏—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ)             |
| 5    | PAE        | Physical Address Extension (1 = 36-–±–∏—Ç–Ω—ã–µ –∞–¥—Ä–µ—Å–∞, —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è x86-64) |
| 7    | PGE        | Global Pages (TLB –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)                    |
| 8    | PCE        | Performance-Monitoring Counter Enable (RDPMC –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º —Ä–µ–∂–∏–º–µ) |
| 9    | OSFXSR     | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ SSE (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 1, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SSE)                    |
| 10   | OSXMMEXCPT | –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π SIMD (SSE/AVX)                                     |
| 13   | SMXE       | Safer Mode Extensions (–¥–ª—è Trusted Execution)                           |
| 14   | SMEP       | Supervisor Mode Execution Prevention (–∑–∞–ø—Ä–µ—Ç –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–æ–¥–∞ –≤ Ring 0) |
| 16   | FSGSBASE   | –†–∞–∑—Ä–µ—à–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ RDFSBASE, WRFSBASE                             |
| 17   | PCIDE      | Process-Context Identifiers (–∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ PCID)                          |
| 18   | OSXSAVE    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ XSAVE/XRSTOR (–¥–ª—è AVX)                                        |
| 20   | SMAP       | Supervisor Mode Access Prevention (–∑–∞–ø—Ä–µ—Ç –¥–æ—Å—Ç—É–ø–∞ Ring 0 –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –¥–∞–Ω–Ω—ã–º) |
| 21   | PKE        | Protection Key Enable                                                   |

–ü—Ä–∏–º–µ—Ä –≤–∫–ª—é—á–µ–Ω–∏—è PAE –∏ SMEP:
mov eax, cr4
or eax, (1 << 5) | (1 << 20)  ; PAE + SMAP
mov cr4, eax
---

## üîπ 6. CR8 (x86-64)
–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π (Task Priority Register, TPR).  
- –£–ø—Ä–∞–≤–ª—è–µ—Ç –º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã—Ö –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å–æ—á–µ—Ç–∞–Ω–∏–∏ —Å APIC (Advanced Programmable Interrupt Controller).

–ü—Ä–∏–º–µ—Ä –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π —Å –Ω–∏–∑–∫–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º:
mov cr8, rax  ; –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Ä–æ–≤–Ω—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ (0-15, –≥–¥–µ 0 = –≤—Å–µ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã)
---

## üîπ 7. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
### 7.1. EFER (Extended Feature Enable Register)
MSR 0xC0000080 ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ (x86-64).

| –ë–∏—Ç  | –ù–∞–∑–≤–∞–Ω–∏–µ       | –û–ø–∏—Å–∞–Ω–∏–µ                          |
|------|----------------|----------------------------------|
| 0    | SCE        | –°–∏—Å—Ç–µ–º–Ω—ã–µ –≤—ã–∑–æ–≤—ã (syscall/sysret) |
| 8    | LME        | Long Mode Enable (–≤–∫–ª—é—á–µ–Ω–∏–µ x86-64) |
| 10   | LMA        | Long Mode Active (—Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ)  |
| 11   | NXE        | No-Execute Enable (–∑–∞–ø—Ä–µ—Ç –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –≤ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö) |

–ü—Ä–∏–º–µ—Ä –≤–∫–ª—é—á–µ–Ω–∏—è x86-64:
mov ecx, 0xC0000080  ; EFER MSR
rdmsr
or eax, (1 << 8)     ; –£—Å—Ç–∞–Ω–æ–≤–∫–∞ LME
wrmsr
### 7.2. XCR0 (Extended Control Register 0)
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π (AVX, MPX, PKRU).

---

## üîπ 8. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
### 8.1. –í–∫–ª—é—á–µ–Ω–∏–µ –∑–∞—â–∏—â—ë–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
cli
lgdt [gdt_descriptor]  ; –ó–∞–≥—Ä—É–∂–∞–µ–º GDT
mov eax, cr0
or eax, 1              ; –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PE (–±–∏—Ç 0)
mov cr0, eax
jmp 0x08:protected_mode
### 8.2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–π –∞–¥—Ä–µ—Å–∞—Ü–∏–∏
mov eax, [page_directory]
mov cr3, eax           ; –£–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —Ç–∞–±–ª–∏—Ü—É —Å—Ç—Ä–∞–Ω–∏—Ü
mov eax, cr0
or eax, 0x80000000     ; –í–∫–ª—é—á–∞–µ–º PG (–±–∏—Ç 31)
mov cr0, eax
### 8.3. –í–∫–ª—é—á–µ–Ω–∏–µ SMEP/SMAP
mov eax, cr4
or eax, (1 << 20) | (1 << 21)  ; SMAP + SMEP
mov cr4, eax
---

## üîπ 9. –ò—Ç–æ–≥: –∫–ª—é—á–µ–≤—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä—ã
| –†–µ–≥–∏—Å—Ç—Ä | –û—Å–Ω–æ–≤–Ω–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                                                 |
|---------|-----------------------------------------------------------------------------------|
| CR0 | –ó–∞—â–∏—â—ë–Ω–Ω—ã–π —Ä–µ–∂–∏–º (PE), —Å—Ç—Ä–∞–Ω–∏—á–Ω–∞—è –∞–¥—Ä–µ—Å–∞—Ü–∏—è (PG), –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (CD/NW)             |
| CR2 | –ê–¥—Ä–µ—Å Page Fault                                                                  |
| CR3 | –£–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —Ç–∞–±–ª–∏—Ü—É —Å—Ç—Ä–∞–Ω–∏—Ü (PML4/PDPT)                                          |
| CR4 | –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏: PAE, SMEP, SMAP, SSE/AVX                                    |
| CR8 | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π (TPR)                                                       |
| EFER| –í–∫–ª—é—á–µ–Ω–∏–µ x86-64 (LME), NX-–±–∏—Ç                                                   |

> ../Ë£ÇÁ∫π#978:
–í–∞–∂–Ω–æ:  
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å CR-—Ä–µ–≥–∏—Å—Ç—Ä–∞–º–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ Ring 0.  
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ CR0/CR4 –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —Å–±—Ä–æ—Å –∫–æ–Ω–≤–µ–π–µ—Ä–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞.  
- –î–ª—è —Ä–∞–±–æ—Ç—ã —Å MSR (EFER, XCR0) –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ RDMSR/WRMSR.  

–ü—Ä–∏–º–µ—Ä —á—Ç–µ–Ω–∏—è CR4:
mov eax, cr4
; eax —Ç–µ–ø–µ—Ä—å —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ CR4
